<head>
    <link rel="shorcut icon" href="data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAYAAADE6YVjAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAJOgAACToAYJjBRwAAACSSURBVEhLY6xZ8+I/A40BE5SmKRi1hCRAlYjPkjkBZWEHFPskim8PlIUbUGRJMMc2KAs/INsS51+roCzCgHFhTzVZcSInJc4gwMfDwM7GBqbxgeGThEctIQmMWkISoIsljOr1hmTl+BnqibTP8Rk350NZhAFFwRVxejKUhR9QHCeBR3uhLNyA7DghBdAhdTEwAAAjyRl/u18AXgAAAABJRU5ErkJggg=="/>
    <title> &lt Maze Escape &gt by jrygeorge </title>
    <style>
        h1 {
            font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
            text-align: center;
            color: antiquewhite;
            margin: 5px;
            text-shadow: 0px 0px 6px rgb(0, 0, 0);
        }
        h3 {
            font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
            text-align: center;
            color: antiquewhite;
            margin: 10px;
        }
        h4 {
            font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
            text-align: center;
            color: rgb(2, 34, 37);
            margin: 3px;
        }
        .stripPart{
            width: 100%;
             height: calc(100% / 3);
        }
        .sky{
            background: rgb(124, 172, 232);
        }
        .wall{
            background: rgb(230, 200, 176);
        }
        .ground{
            background: rgb(39, 127, 49);
        }
    </style>
</head>

<body style="background-color:rgb(2, 73, 80);">
<div id="container" style="margin: auto; width: 50%; height: 80%;  background: black; box-shadow: 0px 0px 10px rgb(18,18,18);">
    <div id="strip0" style="float: left; width: 100%; height: 100%;">
        <div class="stripPart sky" id="sky"> </div>
        <div class="stripPart wall" id="wall"> </div>
        <div class="stripPart ground" id="ground"> </div>
    </div>
</div>

<h1> 
   &lt Maze Escape &gt
</h1> 
<h3>
    AD or ←→ to look around <br>
    WS or ↑↓ to move 
</h3>
<h4>
    made by jrygeorge :)
</h4>

<script>

function canBeMovedTo(newX, newY){
    let coX = Math.floor(newX/blockSize)
    let coY = Math.floor(newY/blockSize)
    if (map[coY][coX] == 1){return false}
    return true
}

function closestDist(){

    let distances = []
    
    for(let ray=-stripNumber/2 ; ray<stripNumber/2 ; ray++){

        rayAngle = (playerAngle + ray*degreesPerStrip + 2*PI)%(2*PI)
        console.log(rayAngle)
        let mx= 0
        let my= 0
        let mp= 0

        let rx= 0
        let ry= 0
        let ra= 0
        let xo= 0
        let yo= 0
        let dof = 0
        let aTan = -1/Math.tan(rayAngle)

        // HORIZONTAL
        if (rayAngle>PI){
            ry = Math.floor(playerPosition[1]/blockSize) - 0.001;
            rx = (playerPosition[1] - ry)*aTan + playerPosition[0];
            yo = -blockSize;
            xo = -yo * aTan
        }
        if (rayAngle<PI){
            ry = Math.floor(playerPosition[1]/blockSize) + blockSize;
            rx = (playerPosition[1] - ry)*aTan + playerPosition[0];
            yo = blockSize;
            xo = -yo * aTan
        }
        if (rayAngle == 0 || rayAngle == PI){
            ry = playerPosition[1];
            rx = playerPosition[0];
            dof = 8;
        }
        while (dof < 8){
            //console.log("dof",dof)
            mx = Math.floor(rx/blockSize);
            my = Math.floor(ry/blockSize);
            if ( (my >= 0) && (my<map.length) && (mx>=0) && (mx<map[0].length) ){
                if (map[my][mx] == 1){ dof = 8; }
                else{
                rx += xo;
                ry += yo;
                dof += 1;
                }
            }
            else {dof = 8;}
        }
        let hx = rx 
        let hy = ry + blockSize
        let dh = Math.sqrt( (hx - playerPosition[0])**2 + (hy - playerPosition[1])**2 );

        // VERTICAL
        dof = 0
        let nTan = -Math.tan(rayAngle)

        if ( (rayAngle<PI*0.5) || (rayAngle>PI*1.5) ){
            rx = Math.floor(playerPosition[0]/blockSize) - 0.001;
            ry = (playerPosition[0] - rx)*nTan + playerPosition[1];
            xo = -blockSize;
            yo = -xo * nTan
        }
        if ( (rayAngle>PI*0.5) && (rayAngle<PI*1.5) ){
            rx = Math.floor(playerPosition[0]/blockSize) + blockSize;
            ry = (playerPosition[0] - rx)*nTan + playerPosition[1];
            xo = blockSize;
            yo = -xo * nTan
        }
        if (rayAngle == 0 || rayAngle == PI){
            ry = playerPosition[1];
            rx = playerPosition[0];
            dof = 8;
        }
        while (dof < 8){
            //console.log("dof",dof)
            mx = Math.floor(rx/blockSize);
            my = Math.floor(ry/blockSize);
            if ( (my >= 0) && (my<map.length) && (mx>=0) && (mx<map[0].length) ){
                if (map[my][mx] == 1){ dof = 8; }
                else{
                rx += xo;
                ry += yo;
                dof += 1;
                }
            }
            else {dof = 8;}
        }
        let vx = rx 
        let vy = ry + blockSize
        let dv = Math.sqrt( (vx - playerPosition[0])**2 + (vy - playerPosition[1])**2 );

        distances.push(Math.min(dh,dv))
    }
    return distances
}

function generateStrips(){
    //document.querySelector('#strip0').style.height = "100%"
    for (let i = 1; i < stripNumber ; i++){
        let currentStrip = document.querySelector('#strip0');
        let clonedStrip = currentStrip.cloneNode(true);
        clonedStrip.id = 'strip'+ (stripNumber-i) ;
        currentStrip.after(clonedStrip)
    }
}

function updateStrips(){
    let shift = Math.random()*2 - 1
    for (let i=0; i<stripNumber; i++){
        let stripName = "strip" + i
        let wallHeight = Math.abs(Math.sin(shift + (2*Math.PI*i)/(1.5*stripNumber)))*35
        let skyGroundHeight = (100 - wallHeight)/2
        document.querySelector("#"+stripName+" #wall").style.height = wallHeight + "%";
        document.querySelector("#"+stripName+" #sky").style.height = skyGroundHeight + 10 + "%";
        document.querySelector("#"+stripName+" #ground").style.height = skyGroundHeight - 10 + "%";
    }
}

function newUpdateStrips(computedDistances){
    for (let i=0; i<stripNumber; i++){
        let stripName = "strip" + i
        let wallHeight =  Math.max(0, 25-0.35*(computedDistances[i]-200))
        
        let skyGroundHeight = (100 - wallHeight)/2
        if (false){
        console.log("comp",computedDistances[i])
        console.log("wall",wallHeight)
        console.log("skyG",skyGroundHeight)}
        document.querySelector("#"+stripName+" #wall").style.height = wallHeight + "%";
        document.querySelector("#"+stripName+" #sky").style.height = skyGroundHeight+10 + "%";
        document.querySelector("#"+stripName+" #ground").style.height = skyGroundHeight-10 + "%";
    }

}

// SET THESE CONSTANTS NICELY SO THERES NO REMAINDER
// I COULD USE FLOOR BUT THEN THERE MIGHT BE OTHER THINGS TO ADJUST
let PI = 3.141592653589
const FOV = 2*PI / 3 // field of vision in rad
const degreesPerStrip = (2*PI / 3)/60 // smaller value -> strip is thinner -> sharper image
const stripNumber = 60//FOV / degreesPerStrip // this is the number of rays
document.getElementById("strip0").style.width = "calc(100% /"+stripNumber+")"


let playerPosition = [150,150] // starting location, [0,0] is top-left
let playerAngle = PI/2 // starting angle, 0 is facing East
let blockSize = 50 // width and height of a "block" in the map

// 0 = empty
// 1 = wall
// 2 = goal
let map = [
            [1,1,1,1,1,1,1],
            [1,0,0,0,0,0,1],
            [1,0,0,0,0,0,1],
            [1,0,0,0,0,0,1],
            [1,0,0,0,0,0,1],
            [1,0,0,0,0,0,1],
            [1,1,1,1,1,1,1]
        ]

document.addEventListener('keydown', function(event){
//console.log(event.key)
    if (["a","ArrowLeft"].includes(event.key)){
        // rotates by PI/10 clockwise
        playerAngle = (playerAngle - PI/40 + 2*PI)%(2*PI)
    }
    if (["d","ArrowRight"].includes(event.key)){
        playerAngle = (playerAngle + PI/40 + 2*PI)%(2*PI)
    }
    if (["w","ArrowUp"].includes(event.key)){
        // finds distance moved in x and y direction, and rounds to ONE decimal place
        futureX = playerPosition[0] + Math.round(10* 20*Math.cos(playerAngle))/10
        futureY = playerPosition[1] + Math.round(10* 20*Math.sin(playerAngle))/10
        if (canBeMovedTo(futureX,futureY)){
            playerPosition[0] = futureX
            playerPosition[1] = futureY
        }
        //else {console.log("HIT BOUNDARY")}
    }
    if (["s","ArrowDown"].includes(event.key)){
        futureX = playerPosition[0] - Math.round(10* 20*Math.cos(playerAngle))/10
        futureY = playerPosition[1] - Math.round(10* 20*Math.sin(playerAngle))/10
        if (canBeMovedTo(futureX,futureY)){
            playerPosition[0] = futureX
            playerPosition[1] = futureY
        }
        //else {console.log("HIT BOUNDARY")}
    }
    if (["w","a","s","d","ArrowUp","ArrowRight","ArrowDown","ArrowLeft"].includes(event.key)){
        newUpdateStrips(closestDist())
        //console.log("closest horizontal",closestDist())
        //console.log("Current playerAngle",playerAngle)
        //console.log("Current playerPos",playerPosition)
    }
} );

window.addEventListener('load', function(event){
    generateStrips()
    updateStrips()
    }
  );


</script>

</body>